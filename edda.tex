%!TEX TS-program = xelatex
%!TEX encoding = UTF-8 Unicode

\documentclass{scrbook}

\usepackage{xltxtra}
\usepackage{polyglossia}
\usepackage{epigraph}
\usepackage{fancyhdr}
\usepackage{boolexpr}
\usepackage{setspace}
\usepackage{tocloft}
\usepackage{typearea}
\usepackage{perpage}
\usepackage{fontspec}
\usepackage{xunicode}
\usepackage{verbatim} 
\usepackage{color}
\usepackage{microtype}
\usepackage{multirow}

% ======================================================================
% macro for switching between draft/release modes
\newcounter{draftcounter}
\newcommand{\isDraft}{\boolexpr{\value{draftcounter} = 1}}
\newcommand{\DraftMode}{\setcounter{draftcounter}{1}}

% ======================================================================
% some macro machinery for readability of conditions

\newcounter{bookformatcounter}

\newcommand{\definebookformat}[1]{
	\newcounter{#1}
	\stepcounter{bookformatcounter}
	\setcounter{#1}{\value{bookformatcounter}}
}

\newcommand{\setbookformat}[1]{
	\newcounter{bookformat}
	\setcounter{bookformat}{\value{#1}}
}

\newcommand{\isAFourOneside}{\boolexpr{\value{bookformat} = \value{bfAFourOneside}}}
\newcommand{\isAFourTwoside}{\boolexpr{\value{bookformat} = \value{bfAFourTwoside}}}
\newcommand{\isAFour}{\boolexpr{\isAFourOneside \OR \isAFourTwoside}}

\newcommand{\isIPad}{\boolexpr{\value{bookformat} = \value{bfIPad}}}

\newcommand{\isSevenInches}{\boolexpr{\value{bookformat} = \value{bfSevenInches}}}

% ======================================================================
% select mode here
\DraftMode

% ======================================================================
% select book format here

% available formats
\definebookformat{bfAFourOneside} % A4, one side (for reading on screen)
\definebookformat{bfAFourTwoside} % A4, two sides (for printing)
\definebookformat{bfIPad} % 9.7'' screen, 3x4, 11pt font, portrait
\definebookformat{bfSevenInches} % 7'' screen, 3x4, 11pt font, portrait

\setbookformat{bfAFourOneside}


% ======================================================================
% Size-dependent definitions
% ======================================================================

\switch
\case{\isAFour}
	\ifcase\isAFourOneside
		\usepackage[a4paper, twoside=false]{geometry}
	\else
		\usepackage[a4paper, twoside=true]{geometry}
	\fi
	\KOMAoptions{headings=big, fontsize=12pt}
	\KOMAoptions{headinclude=true, DIV=15}
	\newcommand{\tocnumwidth}{5em}
	\newcommand{\tocspacing}{1.0} % ToC almost fits 2 pages, we need to help it a bit
	\newcommand{\tocmarginwidth}{2.55em} % left indent for non-first lines of ToC
	\newcommand{\titlesize}{48pt}
	\setlength{\parindent}{1.5em}
\case{\isIPad}
	\usepackage[papersize={5.82in,7.76in}, twoside=false]{geometry}
	\areaset{5.5in}{7.44in} % using the whole screen, IPad already has "physical" margin
	\KOMAoptions{headings=normal, fontsize=11pt}
	\KOMAoptions{headinclude=true}
	\newcommand{\tocnumwidth}{5em}
	\newcommand{\tocspacing}{0.9} % ToC almost fits 2 pages, we need to help it a bit
	\newcommand{\tocmarginwidth}{2.55em} % left indent for non-first lines of ToC
	\setlength{\parindent}{1em}
\case{\isSevenInches}
	\usepackage[papersize={4.8in,5.6in}, twoside=false]{geometry}
	\areaset{4.5in}{5.4in} % using the whole screen, readers have "physical" margin
	\KOMAoptions{headings=normal, fontsize=11pt}
	\KOMAoptions{headinclude=true}
	\newcommand{\tocnumwidth}{5em}
	\newcommand{\tocspacing}{0.9}
	\newcommand{\tocmarginwidth}{2.55em} % left indent for non-first lines of ToC
	\setlength{\parindent}{1em}
\endswitch
\recalctypearea


% ======================================================================
% Size-independent definitions
% ======================================================================

\setmainfont[Mapping=tex-text]{Charis SIL}
\setsansfont[Mapping=tex-text]{Optima}

\newfontfamily\numberfont[Mapping=tex-text]{Optima}
\newfontfamily\commentfont[Mapping=tex-text]{Charis SIL}
\newfontfamily\stanzafont[Mapping=tex-text]{Gentium}

\setmainlanguage{english}
\setotherlanguage{icelandic}
\pagestyle{fancy} % enable fancy headers

% FIXME: probably more accurate tuning is needed
% but this values do not produce overfull hboxes, so they are good enough for a start
% (otherwise I would have to wrap single paragraphs in \sloppy...\fussy)

% tolerance for paragraph badness
\tolerance = 1000

% if two first passes fail and this value is nonzero, TeX will perform the third pass, using additional whitespace
\emergencystretch = 20pt	

% prefer uneven page borders and constant distance between paragraphs
\raggedbottom

\MakePerPage{footnote} % reset footnote counter on each page

% try not to allow cases when last paragraph line starts a new page or when first paragraph line ends a page
\widowpenalty=1300
\clubpenalty=1300

% proper hyphenation for complex words
\XeTeXinterchartokenstate=1
\XeTeXcharclass `\- 24
\XeTeXinterchartoks 24 0 = {\hskip\z@skip}
\XeTeXinterchartoks 0 24 = {\nobreak}

\newcommand{\mdash}{---}
\newcommand{\ndash}{--}
\newcommand{\sdash}{---} % dash for the beginning of speech (babel uses "--* for it)
\newcommand{\enummdash}{---} % mdash for enumerations
\newcommand{\commamdash}{---} % mdash after comma

% ======================================================================
% Stanza magic
% ======================================================================

% in case you want to change the way stanza number is displayed
\newcommand{\displaystanzanum}[1]{{\numberfont\Large\textbf{#1.}}}

\newcommand{\mystanzapair}[4][\@empty]{

\phantomsection
\label{\thischapterlabel:#2}

\hskip -3\parindent
\begin{tabular}{@{} r @{} p{0.48\textwidth} @{} p{0.5\textwidth}}

\makebox[2\parindent][r]{\displaystanzanum{#2}\quad}

&

\begin{minipage}[t]{0.46\textwidth}
\setstretch{1.3}\selectfont\texticelandic{\stanzafont#3}
\end{minipage}

&

\begin{minipage}[t]{0.5\textwidth}
\setstretch{1.3}\selectfont\textenglish{\stanzafont#4}
\end{minipage} 

\end{tabular}

\ifx\@empty#1
\else
\nopagebreak
\vskip \baselineskip
\commentfont#1
\fi
\vskip 2\baselineskip

}

\newcommand{\myverse}[1]{
	{\stanzafont
		\begin{verse}
		#1
		\end{verse}
	}
}

\newcommand{\thischapterlabel}{Stub value, should not see it}
\newcommand{\eddachapter}[3]{
	\addchap[#1 (#3)]{#1}
	\vskip -\baselineskip
	{\Large\sffamily #3}
	\vskip 2\baselineskip
	\renewcommand{\thischapterlabel}{cha:#2}
	\label{\thischapterlabel}

	% Additional label variants
	% Rationale:
	% 1. I want labels to appear in text in italic.
	% 2. Punctuation near italic text must be italic too.
	% 3. \hyperref does not support complex macros (I tired to use xstring to cut punctuation from labels) as labels (probably one has to somehow explicitly evaluate them, but I did not manage to do that).
	% 4. I want to hide all complexity in macros (and writing something like \chapterref{Voluspo}{,} is just ugly).
	% Therefore it seems like the simplest solution.
	\label{\thischapterlabel.}
	\label{\thischapterlabel,}
	\label{\thischapterlabel:}
	\label{\thischapterlabel;}
}

% No spaces in these macros, because TeX considers them to be significant

\ifcase\isDraft
	\newcommand{\chapterref}[1]{\textcolor{red}{\emph{#1}}}
	\newcommand{\stanzaref}[2][\@empty]{\textcolor{red}{#2}}
\else
	\newcommand{\chapterref}[1]{\hyperref[cha:#1]{\emph{#1}}}
	\newcommand{\stanzaref}[2][\@empty]{\ifx\@empty#1\hyperref[\thischapterlabel:#2]{#2}\else\hyperref[cha:#1:#2]{#2}\fi}
\fi

\newcommand{\stanzarangeref}[3][\@empty]{\stanzaref[#1]{#2}\ndash\stanzaref[#1]{#3}}
\newcommand{\combinedref}[2]{\chapterref{#1,} \stanzaref[#1]{#2}}
\newcommand{\combinedrangeref}[3]{\chapterref{#1,} \stanzarangeref[#1]{#2}{#3}}
	
\newcommand{\lacuna}{. . .}

% separator for half-lines in stanzas
\definecolor{gray}{cmyk}{0,0,0,0.5}
\newcommand{\sep}{\textcolor{gray}{~|~}}

\newcommand*\sepline{
	\begin{center}
	\rule[1ex]{.5\textwidth}{.5pt}
	\end{center}
}

\newcommand{\mydagger}{$\dagger$}

% Pdf converter settings
\usepackage{cmap}
\usepackage[bookmarks, bookmarkstype=toc, pdfborder={0 0 0}, pdfa=true]{hyperref}
\hypersetup{pdftitle={Poetic Edda}}

% ======================================================================
% Main document 
% ======================================================================
\begin{document}

% title
\title{\fontsize{\titlesize}{\titlesize}\selectfont Poetic Edda}
\subtitle{\Large{Old Norse{\ndash}English diglot}}
\author{
Original text from ``Die Lieder der älteren Edda'' \\
by Karl Hildebrand and Hugo Gering, \\
translation and comments by \\
Henry Adams Bellows
}

\date{}
\publishers{\small{Typeset by Bogdan Opanchuk, \\ compiled on \today \\ Melbourne, Australia}}

\maketitle

\frontmatter

\clearpage
\begingroup

	% Disable page numbers
	\pagestyle{empty}
	\renewcommand*{\chapterpagestyle}{empty}
	\tocloftpagestyle{empty} % due to tocloft package, ToC is not affected by common page style

	\renewcommand{\@pnumwidth}{\tocnumwidth}
	\renewcommand{\@tocrmarg}{\tocmarginwidth plus1fil} % make ToC flushed to the left

	\begin{spacing}{\tocspacing}
	\tableofcontents
	\end{spacing}

\clearpage
\endgroup

\mainmatter

% ascii -> gering (bellows)
% a` -> á (ā)
% A` -> Á (Ā)
% e` -> é (ē)
% e:: -> ë
% o` -> ó (ō)
% O` -> Ó (Ō)
% y` -> ý (ȳ)
% u` -> ú (ū)
% i` -> í (ī)
% i:: -> ï
% I` -> Í (Ī)
% o/ -> ø (ö) - I use ø
% o/` -> ǿ (ő) - I use ø̄
% O/ -> Ø (Ö) - I use Ø
% O/` -> Ǿ (Ő) - I use Ø̄
% o~ -> ǫ
% o~` -> ǫ́ (ǭ)
% O~ -> Ǫ
% O~` -> Ǫ́ (Ǭ)
% a_e -> æ
% æ` -> ǽ (ǣ)
% a_e` -> ǽ (ǣ)

\include{build/introduction}
\include{build/voluspo}
%\include{build/hovamol}
%\include{build/pronounciation}

\end{document}